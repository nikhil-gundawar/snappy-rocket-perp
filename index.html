<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Flappy Rocket â€” Nebula Edition</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0320">
<meta name="apple-mobile-web-app-title" content="Flappy Rocket">
<link rel="icon" href="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'>
  <rect width='512' height='512' rx='64' fill='%23020a1a'/>
  <g transform='translate(64,64)'>
    <path d='M96 320 L220 220 L180 200 L340 80 L380 120 L230 240 L280 260 L160 380 Z' fill='%23fff'/>
    <circle cx='380' cy='80' r='24' fill='%23ffd54d'/>
  </g>
</svg>">

<style>
  :root{
    --bg1: #050014;
    --bg2: #140022;
    --ui: rgba(255,255,255,0.9);
    --accent: #ffb86b;
  }
  html,body{height:100%;margin:0;background:var(--bg1);-webkit-tap-highlight-color:transparent;}
  #gameWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;}
  canvas{width:100%;height:100%;max-width:900px;max-height:1600px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);background:transparent;display:block;}
  /* HUD & menus */
  .hud{position:absolute;left:18px;top:18px;color:var(--ui);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;z-index:40}
  .hud .score{font-size:20px;font-weight:700;letter-spacing:1px}
  .topRight{position:absolute;right:18px;top:18px;color:var(--ui);z-index:40;display:flex;gap:10px;align-items:center}
  button.iconBtn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:var(--ui);padding:8px;border-radius:10px;font-size:14px}
  /* start menu */
  #menu{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:50}
  .menuCard{width:90%;max-width:520px;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:14px;padding:18px;backdrop-filter:blur(6px);box-shadow:0 6px 20px rgba(0,0,0,0.6);text-align:center;color:var(--ui)}
  .menuCard h1{margin:6px 0 8px;font-size:24px}
  .skins{display:flex;gap:10px;justify-content:center;margin:12px 0}
  .skinBtn{width:60px;height:60px;border-radius:10px;border:2px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;cursor:pointer}
  .small{font-size:13px;color:rgba(255,255,255,0.85)}
  .muted{opacity:0.7;font-size:12px}
  .controls{display:flex;gap:8px;justify-content:center;margin-top:12px}
  /* splash / install hint */
  #splash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#050010 0%,#07001a 60%);z-index:60;color:var(--ui);font-family:system-ui;padding:18px}
  .logoSVG{width:120px;height:120px;margin:0 auto 12px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6))}
  .smallNote{font-size:13px;color:rgba(255,255,255,0.85)}
  /* game over */
  #gameOver{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:70}
  .overCard{background:linear-gradient(180deg,rgba(0,0,0,0.5),rgba(0,0,0,0.4));padding:16px;border-radius:12px;color:var(--ui);text-align:center}
  .overCard h2{margin:4px 0 6px}
  .mutedSmall{opacity:0.8;font-size:13px}
  /* tiny footer */
  .footer{position:absolute;left:12px;bottom:12px;color:rgba(255,255,255,0.6);font-size:12px}
  @media (min-width:700px){ .menuCard h1{font-size:28px} }
</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="c" width="540" height="960" aria-label="Flappy Rocket game canvas"></canvas>

  <div class="hud" id="hud">
    <div class="score" id="score">Score: 0</div>
    <div class="small muted" id="best">Best: 0</div>
  </div>

  <div class="topRight">
    <button class="iconBtn" id="muteBtn">ðŸ”Š</button>
    <button class="iconBtn" id="installBtn">Install</button>
  </div>

  <!-- Start menu -->
  <div id="menu">
    <div class="menuCard">
      <svg class="logoSVG" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Rocket">
        <rect width="64" height="64" rx="12" fill="#070018"/>
        <g transform="translate(6,6)" fill="none">
          <path d="M10 44c8-2 24-20 28-28 0 0-6 0-12 4-6 4-12 10-16 16-4 6-4 8 0 8z" fill="#d0d6ff"/>
          <circle cx="28" cy="28" r="6" fill="#fff"/>
          <path d="M2 52c0-6 8-10 8-10s4 8 0 12c-4 4-8-2-8-2z" fill="#ff7a00" opacity="0.95"/>
        </g>
      </svg>
      <h1>Flappy Rocket â€” Nebula</h1>
      <div class="small">Fly your rocket through the asteroids. Tap to thrust. Install for full-screen play.</div>

      <div style="margin-top:12px;text-align:center">
        <div class="small muted">Choose your rocket</div>
        <div class="skins" id="skins">
          <div class="skinBtn" data-skin="red" style="background:linear-gradient(180deg,#ff6b6b,#b80000);color:black">Red</div>
          <div class="skinBtn" data-skin="blue" style="background:linear-gradient(180deg,#6bb3ff,#004b9b);color:black">Blue</div>
          <div class="skinBtn" data-skin="gold" style="background:linear-gradient(180deg,#ffd27f,#c57c00);color:black">Gold</div>
          <div class="skinBtn" data-skin="mystery" style="background:linear-gradient(180deg,#9b5cdb,#3a0f7a);color:white">Mystery</div>
        </div>
      </div>

      <div class="controls">
        <button class="iconBtn" id="playNow">Play</button>
        <button class="iconBtn" id="howBtn">How to</button>
      </div>

      <div style="margin-top:12px" class="muted">High score stored locally on this device.</div>
    </div>
  </div>

  <!-- Splash while loading -->
  <div id="splash" style="display:flex">
    <div style="text-align:center">
      <svg class="logoSVG" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="12" fill="#050018"/>
        <path d="M20 44c8-2 24-20 28-28 0 0-6 0-12 4-6 4-12 10-16 16-4 6-4 8 0 8z" fill="#d0d6ff"/>
        <circle cx="28" cy="28" r="6" fill="#fff"/>
        <path d="M12 52c0-6 8-10 8-10s4 8 0 12c-4 4-8-2-8-2z" fill="#ff7a00" opacity="0.9"/>
      </svg>
      <div class="smallNote">Flappy Rocket â€” preparing nebula...</div>
    </div>
  </div>

  <!-- Game over overlay -->
  <div id="gameOver">
    <div class="overCard">
      <h2 id="overTitle">You Crashed!</h2>
      <div class="mutedSmall" id="overScore">Score: 0</div>
      <div style="height:8px"></div>
      <button class="iconBtn" id="restartBtn">Restart</button>
      <button class="iconBtn" id="menuBtn">Menu</button>
    </div>
  </div>

  <div class="footer">Tap the screen to boost â€¢ Skins unlock visual variety</div>
</div>

<script>
/* ======= Game variables ======= */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let DPR = Math.max(1, window.devicePixelRatio || 1);
let vw = canvas.width = Math.min(900, Math.max(360, Math.floor(window.innerWidth * 0.95)));
let vh = canvas.height = Math.min(1600, Math.max(600, Math.floor(window.innerHeight * 0.9)));
canvas.style.width = vw + 'px';
canvas.style.height = vh + 'px';
canvas.width = Math.floor(vw * DPR);
canvas.height = Math.floor(vh * DPR);
ctx.scale(DPR, DPR);

let playing = false;
let gameOver = false;
let score = 0;
let best = parseInt(localStorage.getItem('fr_best')||'0',10);
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
bestEl.textContent = 'Best: ' + best;

/* ======= Audio via WebAudio (synthesized to keep single-file small) ======= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let soundOn = true;
function ensureAudio(){
  if(!AudioCtx) return null;
  if(!audioCtx) audioCtx = new AudioCtx();
  return audioCtx;
}
function playTone(type, freq, dur, vol=0.15){
  if(!soundOn) return;
  const ac = ensureAudio();
  if(!ac) return;
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(ac.destination);
  o.start();
  const now = ac.currentTime;
  g.gain.setValueAtTime(vol, now);
  g.gain.exponentialRampToValueAtTime(0.001, now + dur);
  o.stop(now + dur + 0.02);
}
function playFlap(){ playTone('sine', 520, 0.1, 0.08); playTone('sawtooth', 780, 0.08, 0.03);}
function playScore(){ playTone('triangle', 900, 0.12, 0.12);}
function playCrash(){ playTone('sawtooth', 120, 0.5, 0.16); playTone('square', 60, 0.5, 0.12); }

/* ======= Nebula background params ======= */
let stars = [];
let planets = [];
let nebulaCols = [
  ['#0b1226','#2b0740','#5b1b6b','#b354b3'],
  ['#030018','#08163a','#2e4bb3','#7ad9ff'],
  ['#040008','#3b0f2f','#8b2d6b','#ff8fb2']
];
let nebulaChoice = nebulaCols[0];
function makeBackground(){
  stars = Array.from({length: 120}, ()=>{
    return {x: Math.random()*vw, y: Math.random()*vh, r: Math.random()*1.5+0.2, s: Math.random()*0.6+0.1, ox: Math.random()*0.8+0.2}
  });
  planets = [
    {x: vw*0.8, y: vh*0.2, r: 36, col: 'rgba(255,255,255,0.06)', speed: 0.02},
    {x: vw*0.2, y: vh*0.6, r: 52, col: 'rgba(0,0,0,0.08)', speed: 0.01}
  ];
}
makeBackground();

/* ======= Rocket & skins ======= */
let rocket = { x: vw*0.12, y: vh*0.5, w: 44, h: 36, vy:0, rotation:0, thrusting:false };
let skins = {
  red: {fill1:'#ff6b6b', fill2:'#b80000', flame:'#ffb86b'},
  blue: {fill1:'#6bb3ff', fill2:'#004b9b', flame:'#a0e7ff'},
  gold: {fill1:'#ffd27f', fill2:'#c57c00', flame:'#ffe0b2'},
  mystery: {fill1:'#9b5cdb', fill2:'#3a0f7a', flame:'#e29bff'}
};
let currentSkin = 'red';

/* ======= Asteroids (obstacles) ======= */
let asteroids = [];
let spawnTimer = 0;
let spawnInterval = 110; // frames
let baseGap = Math.floor(Math.max(120, vh*0.22));
let speed = 2.2;

/* ======= Particles for explosion ======= */
let particles = [];

/* ======= UI Elements ======= */
const menu = document.getElementById('menu');
const splash = document.getElementById('splash');
const gameOverEl = document.getElementById('gameOver');
const overScore = document.getElementById('overScore');
const overTitle = document.getElementById('overTitle');

/* ======= Helpers ======= */
function resetGame(){
  asteroids = [];
  particles = [];
  score = 0;
  spawnTimer = 0;
  rocket.y = vh*0.5;
  rocket.vy = 0;
  rocket.rotation = 0;
  playing = true;
  gameOver = false;
  speed = 2.2;
  baseGap = Math.floor(Math.max(120, vh*0.22));
  updateHUD();
  playFlap();
}
function updateHUD(){
  scoreEl.textContent = 'Score: ' + score;
  bestEl.textContent = 'Best: ' + best;
}

/* ======= Controls and touch ======= */
function doThrust(){
  rocket.vy = -8;
  rocket.thrusting = true;
  rocket.rotation = -0.6;
  playFlap();
  setTimeout(()=>rocket.thrusting=false,120);
}
window.addEventListener('touchstart', (e)=>{
  e.preventDefault();
  ensureAudio();
  if(!playing && !gameOver){ // from menu
    startFromMenu();
    return;
  }
  if(gameOver) return;
  doThrust();
}, {passive:false});
window.addEventListener('mousedown', (e)=>{ // desktop support
  if(!playing && !gameOver) { startFromMenu(); return; }
  if(gameOver) return;
  doThrust();
});

/* ======= Skin selection & menu buttons ======= */
document.querySelectorAll('.skinBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.skinBtn').forEach(b=>b.style.outline='none');
    btn.style.outline='3px solid rgba(255,255,255,0.08)';
    currentSkin = btn.dataset.skin;
  });
});
document.getElementById('playNow').addEventListener('click', ()=>{ startFromMenu(); });
document.getElementById('howBtn').addEventListener('click', ()=>{
  alert('Tap anywhere to thrust upward. Dodge asteroids. Get as far as you can!');
});

/* ======= Mute / install buttons ======= */
const muteBtn = document.getElementById('muteBtn');
muteBtn.addEventListener('click', ()=>{
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'ðŸ”Š' : 'ðŸ”‡';
});
let deferredInstall = null;
const installBtn = document.getElementById('installBtn');
installBtn.addEventListener('click', async ()=>{
  if(window.deferredPrompt){
    window.deferredPrompt.prompt();
    const choice = await window.deferredPrompt.userChoice;
    window.deferredPrompt = null;
  } else {
    alert('To install: in Safari tap Share â†’ Add to Home Screen.');
  }
});

/* ======= Main loop & draw functions ======= */
function spawnAsteroid(){
  const gap = baseGap - Math.min(40, Math.floor(score*1.2));
  const top = Math.floor(Math.random()*(vh - gap - 120))+60;
  asteroids.push({
    x: vw + 60,
    top: top,
    bottom: top + gap,
    w: Math.floor(vw*0.12),
    rot: Math.random()*Math.PI*2,
    rotSpeed: (Math.random()-0.5)*0.03,
    r: 18 + Math.random()*28
  });
}
function createParticles(x,y,col,count=24){
  for(let i=0;i<count;i++){
    particles.push({
      x:x, y:y,
      vx:(Math.random()-0.5)*6, vy:(Math.random()-0.5)*6,
      life: 40+Math.random()*30,
      col: col,
      size: 2+Math.random()*3
    });
  }
}
function explodeRocket(){
  createParticles(rocket.x + rocket.w*0.5, rocket.y + rocket.h*0.5, '#ff7a33', 48);
  playCrash();
}

/* collision check */
function checkCollision(a){
  // rocket rect vs asteroid rect (two rects: top and bottom)
  const rx = rocket.x, ry = rocket.y, rw = rocket.w, rh = rocket.h;
  // top rect
  if(rx < a.x + a.w && rx + rw > a.x && (ry < a.top)) return true;
  if(rx < a.x + a.w && rx + rw > a.x && (ry + rh > a.bottom)) return true;
  return false;
}

/* draw nebula background */
let nebulaOffset = 0;
function drawBackground(){
  nebulaOffset += 0.2;
  // gradient nebula
  const grd = ctx.createLinearGradient(0,0,0,vh);
  grd.addColorStop(0, nebulaChoice[0]);
  grd.addColorStop(0.35, nebulaChoice[1]);
  grd.addColorStop(0.7, nebulaChoice[2]);
  grd.addColorStop(1, nebulaChoice[3]);
  ctx.fillStyle = grd;
  ctx.fillRect(0,0,vw,vh);

  // soft clouds
  for(let i=0;i<4;i++){
    ctx.globalAlpha = 0.06 + (i*0.02);
    ctx.fillStyle = nebulaChoice[(i+1)%nebulaChoice.length];
    const x = (i*260 + nebulaOffset*0.3) % (vw+300) - 150;
    const y = vh*0.15 + i*vh*0.12;
    ctx.beginPath();
    ctx.ellipse(x,y, vw*0.6, vh*0.22, Math.sin(nebulaOffset*0.01+i)*0.2, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;

  // planets
  planets.forEach(p=>{
    p.x -= p.speed * 0.3;
    if(p.x + p.r < -50) p.x = vw + 120;
    ctx.beginPath();
    ctx.fillStyle = p.col;
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
    // ring
    ctx.strokeStyle = 'rgba(255,255,255,0.02)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(p.x, p.y, p.r*1.5, p.r*0.5, 0.3, 0, Math.PI*2);
    ctx.stroke();
  });

  // stars parallax
  stars.forEach(s=>{
    s.x -= s.s * 0.4;
    if(s.x < -2) { s.x = vw + 2; s.y = Math.random()*vh; }
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.fillRect(s.x, s.y, s.r, s.r);
  });
}

/* draw rocket */
function drawRocket(){
  ctx.save();
  ctx.translate(rocket.x + rocket.w*0.5, rocket.y + rocket.h*0.5);
  ctx.rotate(rocket.rotation);
  // body
  const skin = skins[currentSkin] || skins['red'];
  ctx.fillStyle = skin.fill1;
  roundRect(ctx, -rocket.w*0.5, -rocket.h*0.5, rocket.w, rocket.h, 6);
  ctx.fill();
  // cockpit
  ctx.fillStyle = 'rgba(255,255,255,0.85)';
  ctx.beginPath();
  ctx.ellipse(rocket.w*0.12, 0, rocket.w*0.25, rocket.h*0.35, 0, 0, Math.PI*2);
  ctx.fill();

  // fins
  ctx.fillStyle = skin.fill2;
  ctx.beginPath();
  ctx.moveTo(-rocket.w*0.45, rocket.h*0.25);
  ctx.lineTo(-rocket.w*0.9, rocket.h*0.55);
  ctx.lineTo(-rocket.w*0.2, rocket.h*0.25);
  ctx.fill();

  // thruster / flame
  if(rocket.thrusting || (Math.sin(Date.now()*0.02) > 0.7)){
    const fcol = skin.flame || '#ffae5c';
    for(let i=0;i<3;i++){
      ctx.fillStyle = mixColor(fcol, 'rgba(255,255,255,0.02)', Math.random()*0.2);
      ctx.beginPath();
      ctx.moveTo(-rocket.w*0.5, -4 + i*3);
      ctx.quadraticCurveTo(-rocket.w - (14+Math.random()*10), (Math.random()*12-6), -rocket.w*0.5, 8 + i*3);
      ctx.fill();
    }
  }

  ctx.restore();
}

/* utils: rounded rect */
function roundRect(ctx,x,y,w,h,r){
  const radius = r;
  ctx.beginPath();
  ctx.moveTo(x+radius,y);
  ctx.arcTo(x+w,y,x+w,y+h,radius);
  ctx.arcTo(x+w,y+h,x,y+h,radius);
  ctx.arcTo(x,y+h,x,y,radius);
  ctx.arcTo(x,y,x+w,y,radius);
  ctx.closePath();
}

/* draw asteroids (as rectangular obstacles with rotation illusion) */
function drawAsteroids(){
  ctx.fillStyle = 'rgba(255,255,255,0.04)';
  asteroids.forEach(a=>{
    // top
    ctx.save();
    ctx.translate(a.x + a.w*0.5, a.top*0.5);
    ctx.rotate(a.rot);
    ctx.fillStyle = 'rgba(60,60,60,0.9)';
    ctx.fillRect(-a.w*0.5, -a.top*0.5, a.w, a.top);
    ctx.restore();

    // bottom
    ctx.save();
    ctx.translate(a.x + a.w*0.5, a.bottom + (vh - a.bottom)*0.5);
    ctx.rotate(-a.rot);
    ctx.fillStyle = 'rgba(60,60,60,0.92)';
    ctx.fillRect(-a.w*0.5, - (vh - a.bottom)*0.5, a.w, (vh - a.bottom));
    ctx.restore();

    // small asteroid circle on top edge for flavor
    ctx.beginPath();
    ctx.fillStyle = 'rgba(120,100,80,0.95)';
    ctx.arc(a.x + a.w*0.55, a.top - 8, a.r, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.fillStyle = 'rgba(100,90,70,0.95)';
    ctx.arc(a.x + a.w*0.45, a.bottom + 8, a.r*0.8, 0, Math.PI*2);
    ctx.fill();
  });
}

/* draw particles */
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy;
    p.vy += 0.18;
    p.life--;
    ctx.globalAlpha = Math.max(0, Math.min(1, p.life/80));
    ctx.fillStyle = p.col;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();
    if(p.life <= 0) particles.splice(i,1);
  }
  ctx.globalAlpha = 1;
}

/* main update */
function update(){
  if(!playing) return;
  // physics
  rocket.vy += 0.45;
  rocket.y += rocket.vy;
  rocket.rotation += ( (rocket.vy/30) - rocket.rotation) * 0.08;

  // spawn asteroids
  spawnTimer++;
  if(spawnTimer > spawnInterval){
    spawnTimer = 0;
    spawnAsteroid();
  }
  // move asteroids
  for(let i=asteroids.length-1;i>=0;i--){
    const a = asteroids[i];
    a.x -= speed;
    a.rot += a.rotSpeed;
    // passed?
    if(!a.passed && a.x + a.w < rocket.x){
      a.passed = true;
      score++;
      updateHUD();
      playScore();
      // increase difficulty slightly
      if(score % 4 === 0) speed += 0.18;
    }
    // out of screen
    if(a.x + a.w < -20) asteroids.splice(i,1);
    // collision
    if(checkCollision(a)){
      // explode
      playing = false;
      gameOver = true;
      explodeRocket();
      if(score > best){ best = score; localStorage.setItem('fr_best', ''+best); }
      showGameOver();
    }
  }

  // boundaries
  if(rocket.y < 0 || rocket.y + rocket.h > vh){
    if(playing){
      playing = false;
      gameOver = true;
      explodeRocket();
      if(score > best){ best = score; localStorage.setItem('fr_best', ''+best); }
      showGameOver();
    }
  }

  // particles
  drawParticles();
}

/* draw frame */
function draw(){
  // background
  drawBackground();
  // asteroids
  drawAsteroids();
  // rocket
  drawRocket();
  // particles (drawn on top)
  drawParticles();
  // HUD drawn by DOM; canvas overlay not needed
}

/* main loop */
function loop(){
  ctx.clearRect(0,0,vw,vh);
  update();
  draw();
  requestAnimationFrame(loop);
}

/* start from menu */
function startFromMenu(){
  // choose nebula palette randomly
  nebulaChoice = nebulaCols[Math.floor(Math.random()*nebulaCols.length)];
  makeBackground();
  menu.style.display = 'none';
  splash.style.display = 'none';
  resetGame();
}

/* show game over */
function showGameOver(){
  overScore.textContent = 'Score: ' + score + ' â€¢ Best: ' + best;
  gameOverEl.style.display = 'flex';
  document.getElementById('overTitle').textContent = score > best ? 'New Best!' : 'You Crashed!';
  updateHUD();
}

/* restart */
document.getElementById('restartBtn').addEventListener('click', ()=>{
  gameOverEl.style.display = 'none';
  resetGame();
});
document.getElementById('menuBtn').addEventListener('click', ()=>{
  gameOverEl.style.display = 'none';
  menu.style.display = 'flex';
  playing = false; gameOver = false;
});

/* helper color mix */
function mixColor(a,b,t){
  // simple mix, not perfect but fine
  try{
    const ca = hexToRgb(a);
    const cb = hexToRgb(b);
    const r = Math.round(ca.r*(1-t)+cb.r*t);
    const g = Math.round(ca.g*(1-t)+cb.g*t);
    const bl = Math.round(ca.b*(1-t)+cb.b*t);
    return 'rgb('+r+','+g+','+bl+')';
  }catch(e){ return a; }
}
function hexToRgb(hex){
  if(hex.startsWith('rgba')){ // very simple parse
    const m = hex.match(/rgba?\(([^)]+)\)/);
    if(m){ const parts=m[1].split(',').map(s=>parseFloat(s)); return {r:parts[0],g:parts[1],b:parts[2]}; }
  }
  hex = hex.replace('#','');
  if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
  const num = parseInt(hex,16);
  return {r:(num>>16)&255, g:(num>>8)&255, b:num&255};
}

/* resize handling */
window.addEventListener('resize', ()=>{
  vw = canvas.style.width = Math.min(900, Math.max(360, Math.floor(window.innerWidth * 0.95)));
  vh = canvas.style.height = Math.min(1600, Math.max(600, Math.floor(window.innerHeight * 0.9)));
  // re-scale canvas backing store
  canvas.width = Math.floor(vw * DPR);
  canvas.height = Math.floor(vh * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  makeBackground();
});

/* small service worker registration attempt (works if hosted over HTTPS) */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/flappyrocket-sw.js').catch(()=>{/*ignore in file://*/});
}

/* hide splash after a short time */
setTimeout(()=>{ try{ splash.style.display='none' }catch(e){} }, 1400);

/* init loop */
loop();

/* expose quick functions for keyboard during desktop testing */
window.__FR = { reset: resetGame, score: ()=>score };

/* ---------- end of script ---------- */
</script>
</body>
</html>
